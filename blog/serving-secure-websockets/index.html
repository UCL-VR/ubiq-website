<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://ubiq.online/fonts/vendor/nunito-sans/nunito-sans-v11-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://ubiq.online/fonts/vendor/nunito/nunito-v22-latin-700.woff2 type=font/woff2 crossorigin><script integrity="sha512-RBYr6Ld4w1yVqaACrgrBLQfPgGhj/1jyacA74WxJ1KM6KVcSWymwrdDwb3HDcdpwiNJ5yssot1He0U9vXoQVlg==">(()=>{var b=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,a=localStorage.getItem("theme");b&&a===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),b&&a==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),a==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=/main.be2ac79d46942b3c1be9b102cb3f8714a31099e650d6d5c9d08f182ec3ddb8f751c2564f2274fddc98ae819330a1da887d17d15f3991255d9d7bf58ae0f3ed4f.css integrity="sha512-virHnUaUKzwb6bECyz+HFKMQmeZQ1tXJ0I8YLsPduPdRwlZPInT93JiugZMwodqIfRfRXzmRJV2de/WK4PPtTw==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Serving Secure WebSockets Ubiq</title><meta name=description content="How to set up the Ubiq server to allow connections from regular browsers"><link rel=canonical href=https://ubiq.online/blog/serving-secure-websockets/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Serving Secure WebSockets"><meta property="og:description" content="How to set up the Ubiq server to allow connections from regular browsers"><meta property="og:url" content="https://ubiq.online/blog/serving-secure-websockets/"><meta property="og:site_name" content="Ubiq"><meta property="article:published_time" content="2022-12-02T09:19:42+01:00"><meta property="article:modified_time" content="2024-04-19T14:41:49+01:00"><meta property="og:image:width" content="1280"><meta property="og:image:height" content="640"><meta property="og:image:alt" content="Serving Secure WebSockets"><meta property="og:image" content="https://ubiq.online/images/banner.png"><meta property="og:image:width" content="1280"><meta property="og:image:height" content="640"><meta property="og:image:alt" content="Ubiq"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="Serving Secure WebSockets"><meta name=twitter:description content="How to set up the Ubiq server to allow connections from regular browsers"><meta name=twitter:image content><meta name=twitter:image:alt content="Serving Secure WebSockets"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://ubiq.online/#/schema/organization/1","name":"Ubiq","url":"https://ubiq.online/","sameAs":["https://github.com/UCL-VR/ubiq"],"logo":{"@type":"ImageObject","@id":"https://ubiq.online/#/schema/image/1","url":"https://ubiq.online/images/logos/ubiq-logo.png","width":512,"height":512,"caption":"Ubiq"},"image":{"@id":"https://ubiq.online/#/schema/image/1"}},{"@type":"WebSite","@id":"https://ubiq.online/#/schema/website/1","url":"https://ubiq.online/","name":"Ubiq","description":"A Unity networking library for research, teaching and development, maintained by the Virtual Environments and Computer Graphics group at UCL. Ubiq is 100% free and open source.","publisher":{"@id":"https://ubiq.online/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://ubiq.online/blog/serving-secure-websockets/","url":"https://ubiq.online/blog/serving-secure-websockets/","name":"Serving Secure WebSockets","description":"How to set up the Ubiq server to allow connections from regular browsers","isPartOf":{"@id":"https://ubiq.online/#/schema/website/1"},"about":{"@id":"https://ubiq.online/#/schema/organization/1"},"datePublished":"2022-12-02T09:19:42CET","dateModified":"2024-04-19T14:41:49CET","breadcrumb":{"@id":"https://ubiq.online/blog/serving-secure-websockets/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://ubiq.online/blog/serving-secure-websockets/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://ubiq.online/blog/serving-secure-websockets/"]}]},{"@type":"BreadcrumbList","@id":"https://ubiq.online/blog/serving-secure-websockets/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://ubiq.online/","url":"https://ubiq.online/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://ubiq.online/blog/","url":"https://ubiq.online/blog/","name":"Blog"}},{"@type":"ListItem","position":3,"item":{"@id":"https://ubiq.online/blog/serving-secure-websockets/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://ubiq.online/#/schema/article/1","headline":"Serving Secure WebSockets","description":"How to set up the Ubiq server to allow connections from regular browsers","isPartOf":{"@id":"https://ubiq.online/blog/serving-secure-websockets/"},"mainEntityOfPage":{"@id":"https://ubiq.online/blog/serving-secure-websockets/"},"datePublished":"2022-12-02T09:19:42CET","dateModified":"2024-04-19T14:41:49CET","author":{"@id":"https://ubiq.online/#/schema/person/2"},"publisher":{"@id":"https://ubiq.online/#/schema/organization/1"},"image":{"@id":"https://ubiq.online/blog/serving-secure-websockets/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://ubiq.online/#/schema/person/2","name":"Nels Numan","sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://ubiq.online/blog/serving-secure-websockets/#/schema/image/2","url":null,"contentUrl":null,"width":1826,"height":874,"caption":"Serving Secure WebSockets"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://ubiq.online/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://ubiq.online/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://ubiq.online/favicon-16x16.png><link rel=manifest href=https://ubiq.online/site.webmanifest></head><body class="single section blog"><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=/ aria-label=Bootstrap>Ubiq</a>
<button class="btn btn-menu d-block d-md-none order-5" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-start border-0 py-md-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-md-none"></div><div class="offcanvas-header d-md-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>Ubiq</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body px-4"><h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3><ul class="nav flex-column flex-md-row ms-md-n3"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://ucl-vr.github.io/ubiq/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/showcase/>Showcase</a></li><li class=nav-item><a class="nav-link ps-0 py-1 active" href=/blog/>Blog</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/publication/>Publications</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/teaching>Teaching</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Contact
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=https://github.com/UCL-VR/ubiq/discussions/categories/q-a>â†— Ask a Question</a></li><li><a class=dropdown-item href=/contributors/>Contributors</a></li><li><a class=dropdown-item href=/media/>Media</a></li></ul></li></ul><hr class="text-black-50 my-4 d-md-none"><h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3><ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://discord.gg/cZYzdcxAAB><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 128 128" fill="#000" stroke="currentcolor" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-discord"><path d="M45.23 57.2c-6.16.0-11.17 5.6-11.17 12.48s5 12.47 11.17 12.47 11.16-5.59 11.16-12.47S51.38 57.2 45.23 57.2zm0 21c-4 0-7.17-3.8-7.17-8.47s3.21-8.48 7.17-8.48 7.16 3.8 7.16 8.48-3.21 8.42-7.16 8.42z"/><path d="M121.83 59.58a156.78 156.78.0 00-11.52-31 2.1 2.1.0 00-.71-.77 87.08 87.08.0 00-15.23-7.17C84.55 17.07 79.91 17 79.72 17a2 2 0 00-2 1.72l-.6 4.17a133.14 133.14.0 00-26.28.0l-.6-4.17a2 2 0 00-2-1.72c-.19.0-4.83.0-14.65 3.61A87.08 87.08.0 0018.4 27.81a2.1 2.1.0 00-.71.77 156.72 156.72.0 00-11.52 31C1 80.46.0 90.91.0 91.34a2 2 0 00.49 1.5 55.2 55.2.0 0018.2 12.74A76.32 76.32.0 0038.48 111a2 2 0 001.92-1l5.4-9.25A105.08 105.08.0 0064 102.24a105.08 105.08.0 0018.2-1.51L87.6 110a2 2 0 001.72 1h.2a76.32 76.32.0 0019.78-5.38 55.2 55.2.0 0018.2-12.74 2 2 0 00.49-1.5C128 90.91 127.05 80.46 121.83 59.58zm-14.06 42.31a76.76 76.76.0 01-17.39 4.92l-4.08-7c4.68-1.24 14.42-4.46 21.83-11.2a2 2 0 10-2.69-3c-9 8.23-22.46 10.84-22.6 10.87h-.06A96.59 96.59.0 0164 98.24a96.59 96.59.0 01-18.78-1.7h-.06c-.14.0-13.55-2.64-22.6-10.87a2 2 0 10-2.69 3c7.41 6.74 17.15 10 21.83 11.2l-4.08 7a76.08 76.08.0 01-17.39-4.92A52.24 52.24.0 014.08 90.8c.33-2.91 1.68-13.07 6-30.24A156.25 156.25.0 0121 30.92 88.17 88.17.0 0135 24.4a61.35 61.35.0 0111.58-3.19l.35 2.39c-4 1-13.85 3.86-21.65 9.53a2 2 0 102.36 3.23c8.82-6.41 21-9.06 21.86-9.25A118.4 118.4.0 0164 26.27a117.64 117.64.0 0114.51.84c.91.19 13 2.83 21.86 9.25a2 2 0 102.36-3.23c-7.8-5.67-17.61-8.52-21.65-9.53l.35-2.39A61.75 61.75.0 0193 24.4a88.17 88.17.0 0114 6.52 156.25 156.25.0 0111 29.64c4.29 17.17 5.64 27.33 6 30.24a52.24 52.24.0 01-16.23 11.09z"/><path d="M82.77 57.2c-6.15.0-11.16 5.6-11.16 12.48s5 12.47 11.16 12.47 11.17-5.59 11.17-12.47S88.93 57.2 82.77 57.2zm0 21c-4 0-7.16-3.8-7.16-8.47s3.21-8.48 7.16-8.48 7.17 3.8 7.17 8.48S86.73 78.15 82.77 78.15z"/></svg><small class="ms-2 d-md-none">Discord</small></a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://github.com/UCL-VR/ubiq/><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div><button id=mode class="btn btn-link order-md-1" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></nav></header><div class="wrap container-xxl" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>Serving Secure WebSockets</h1><p><small>Posted December 2, 2022 by <a class="stretched-link position-relative" href=/contributors/sebastian-friston/>Sebastian Friston</a>&nbsp;&dash;&nbsp;<strong>8&nbsp;min read</strong></small><p></div><p class=lead>The latest version of Ubiq serves secure WebSockets by default. See what you need to do to support this in your own deployments.</p><h2 id=introduction>Introduction</h2><p>Ubiq 0.0.3 supports building for WebGL <em>out-of-the-box</em> in Unity.</p><p>Ubiq has always supported Javascript clients, but now users have the option of building native browser clients, or building for the web directly in Unity.</p><p>WebGL support is experimental, and some features are still a work in progress, such as Voice Chat.</p><p>This post is not about building for the browser however, but what it required to support the browser behind the scenes&mldr;</p><h2 id=secure-websockets>Secure WebSockets</h2><p>Unity can build applications for browser by targetting WebGL.</p><p>This target transpiles the Unity game into WebAssembly, which runs within a tab&rsquo;s Javascript Runtime/Virtual Machine, with all its abilities and constraints.</p><p>There are three ways Javascript applications talk to the outside world.</p><ol><li>They can make regular HTTP calls using XHR.</li><li>They can use the WebRtc API to create a Peer Connection, that can include a Data Channel operating similarly to UDP.</li><li>Or they can use <a href=https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API>WebSockets</a>. These start out as HTTP connections which upgrade themselves into WebSocket connections, keeping the connection open and presenting something akin to a message-based version of TCP.</li></ol><p>Opening WebSockets is straightforward in Javascript, but with restrictions on their use.</p><p>For example, the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy>Content Security Policy</a> <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/upgrade-insecure-requests><code>upgrade-insecure-requests</code></a> prevents scripts upgrading an HTTPS connection to an insecure WebSocket connection, and the phase-out of insecure HTTP has been in progress for <a href=https://blog.mozilla.org/security/2015/04/30/deprecating-non-secure-http/>years</a>&mldr;</p><p>While it is possible to <a href=https://www.damirscorner.com/blog/posts/20210528-AllowingInsecureWebsocketConnections.html>override</a> this behavour it weakens security, and will only become harder as time goes on.</p><p>The latest version of the Ubiq tries to make doing the correct thing easy, by making secure WebSockets the default.</p><p>This requires some additional work to deploy however, to allow HTTPS to meet its goals.</p><p><strong>(And remember you don&rsquo;t need to do any of this if you don&rsquo;t want to recieve connections from the browser! You can also use our development server, Nexus.)</strong></p><h2 id=what-is-https>What is HTTPS?</h2><p>The purpose of HTTPS is to provide <em>privacy</em> and <em>authentication</em>.</p><p>HTTPS is HTTP over TLS - Transport Security Layer. That is, it operates over a regular TCP connection but with encrypted traffic.</p><p>When a TSL connection is opened, the client and server use an asymmetric cipher to agree on a way to encrypt data flowing between them.</p><p>This works by having the server offer up a public key. The client uses this to send a secret to the server. The nature of <a href=https://en.wikipedia.org/wiki/Public-key_cryptography>public key encryption</a> means only the server (with its private key) can decode the secret. The secret is used to set up encryption for user data.</p><p>This provides privacy. But it&rsquo;s the provision of the public key that interests us however, because this is what enables the second goal of HTTPS: <em>authentication</em>.</p><h3 id=certificates>Certificates</h3><p>Any public-private key pair could be used to create an encrypted connection between two sockets.</p><p>Browsers won&rsquo;t just accept any public key however, because doing so still leaves users vulnerable to <a href=https://en.wikipedia.org/wiki/Man-in-the-middle_attack>MITM attacks</a>.</p><p>It is not much use securing information from snooping, if it will be streamed directly to an attacker!</p><p>To protect against this, servers provide their public keys in a <em>certificate</em>. The certificate verifies that the public key belongs to the host, and that the host is who it claims to be.</p><p>Certificates themselves are signed with the private key of a Certificate Authority (CA). The Certificate Authority is an entity that can be trusted to issue certificates.</p><p>Certificates have a <em>chain of trust</em>. Certificates can be used to create (sign) other certificates. At the top of the chain, is the Root Certificate, which is self-signed.</p><p><figure class=figure><img class="figure-img img-fluid lazyload blur-up" data-sizes=auto src=https://ubiq.online/blog/serving-secure-websockets/chain-of-trust_huc9dc67316e856056737ba71d8fd08584_93814_20x0_resize_box_3.png data-srcset="https://ubiq.online/blog/serving-secure-websockets/chain-of-trust_huc9dc67316e856056737ba71d8fd08584_93814_900x0_resize_box_3.png 900w,https://ubiq.online/blog/serving-secure-websockets/chain-of-trust_huc9dc67316e856056737ba71d8fd08584_93814_800x0_resize_box_3.png 800w,https://ubiq.online/blog/serving-secure-websockets/chain-of-trust_huc9dc67316e856056737ba71d8fd08584_93814_700x0_resize_box_3.png 700w,https://ubiq.online/blog/serving-secure-websockets/chain-of-trust_huc9dc67316e856056737ba71d8fd08584_93814_600x0_resize_box_3.png 600w,https://ubiq.online/blog/serving-secure-websockets/chain-of-trust_huc9dc67316e856056737ba71d8fd08584_93814_500x0_resize_box_3.png 500w" width=1920 height=1080 alt=me><noscript><img class="figure-img img-fluid" sizes=100vw srcset="https://ubiq.online/blog/serving-secure-websockets/chain-of-trust_huc9dc67316e856056737ba71d8fd08584_93814_900x0_resize_box_3.png 900w,https://ubiq.online/blog/serving-secure-websockets/chain-of-trust_huc9dc67316e856056737ba71d8fd08584_93814_800x0_resize_box_3.png 800w,https://ubiq.online/blog/serving-secure-websockets/chain-of-trust_huc9dc67316e856056737ba71d8fd08584_93814_700x0_resize_box_3.png 700w,https://ubiq.online/blog/serving-secure-websockets/chain-of-trust_huc9dc67316e856056737ba71d8fd08584_93814_600x0_resize_box_3.png 600w,https://ubiq.online/blog/serving-secure-websockets/chain-of-trust_huc9dc67316e856056737ba71d8fd08584_93814_500x0_resize_box_3.png 500w" src=https://ubiq.online/blog/serving-secure-websockets/chain-of-trust.png width=1920 height=1080 alt=me></noscript></figure>(CC BY-SA 4.0 Attribution: Yuhkih)</p><p>Root Certificates, which can be used to verify the entire chain, are distributed as part of operating systems and browsers.</p><p>Certificate Authorities are trusted by these <a href=https://learn.microsoft.com/en-us/security/trusted-root/program-requirements>manufacturers</a>, due to the significant <a href=https://arstechnica.com/information-technology/2012/11/inside-symantecs-ssl-certificate-vault/>real world physical security</a> they employ to protect their private keys.</p><h2 id=what-this-means-for-custom-deployments>What this means for custom deployments</h2><p>Browsers won&rsquo;t make secure connections to a host unless it can prove its identity with a certifcate derived from one of the world&rsquo;s <a href=https://w3techs.com/technologies/history_overview/ssl_certificate>Root CAs</a>.</p><p>Therefore, the first step in deploying a Ubiq server supporting WebSockets is to acquire a certificate.</p><p>If you are using institutional resources, you can ask your technical support group for one.</p><p>Alternatively, you can purchase a certificate from a retail issuer such as the Comodo SSL Store.</p><p>The non-profit <a href=https://letsencrypt.org/>Lets Encrypt</a> provides certificates free of charge.</p><p>If you choose to acquire your own certificate from Lets Encrypt or another provider, they will verify you own the domain the server is running on by asking you to fulfil various challenges. For example, updating a DNS record, or serving particular content at a specified URI. Once they have verified you control the domain, the certificate will be issued.</p><p>Once you have the certificate, it must be provided to the Ubiq Server.</p><p>This is done by setting the cert and key properties under the wss configuration to the paths of your certificate and private key.</p><pre><code>{
    &quot;roomserver&quot;:
    {
        &quot;tcp&quot;:
        {
            &quot;port&quot;: 8009
        },
        &quot;wss&quot;:
        {
            &quot;port&quot;: 8010,
            &quot;cert&quot;: &quot;./cert.pem&quot;,
            &quot;key&quot;: &quot;./key.pem&quot;
        }
    },
    &quot;iceservers&quot;:
    [
        {
            &quot;uri&quot; : &quot;stun:stun.l.google.com:19302&quot;
        }
    ]
}
</code></pre><p>The example configuration looks for the certificate and key in the same folder as <code>app.js</code>.</p><p>The server expects the certificate and key to be in the PEM format.</p><p>PEM is a container format which describes how a certificate or key should be stored (in base64) and the headers that describe what is in the PEM.</p><p>Different providers will deliver keys with various formats and extensions. Before doing anything else you should check if the certificate and key are already in PEM format by opening them with a text editor.</p><p>If the file starts with <code>-----BEGIN</code>, then the file is already in PEM format. If the content is binary, it will need to be converted to PEM.</p><p>For example, this is an (abridged) private key in PEM format generated with the command <code>ssh-keygen -f "C:\mykey.pem"</code>:</p><pre><code>-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAvLW7is3EEW52qjPalsDYTsIRdRut2MZfeKC0oL/idw+ZaX8+wJJz
kW+Es9Ddf0YAkuZQHyRK4GV5Z8D7Vl2yVJP0x6fgHZ5AOv5xi17KMrsCsN+2LJriwMFLCz
s7621XlIEIIrv+DqLDtR96bm9GRNWYola4c1jdHK3maLiVC3U0QeXIlFs7oJfnYPJrtO2Y
xlpKkQlng8f8ZgLDws8dGqnEwst+1I1Mg2wvfYsJ2jl9Ypg6DSXDw5Skl8KKrnUVNVvuYt
...
6aXtX7hgiq1uVekivPX6scILHXeOewfLRYUlv9WFDD5Veu2r0zzGeXkLCDUjJAnYAHe2uL
XkG1JGuymV/GOd6odbri0w5KvekggHTrZvLpZ/feLPTG3SdkExYgpayiX4OQGW0jXfiUmR
6K7eEpuj1UFqf5pm6fYrGVx5Ft9ral3fhg0Mn0s7P1t59HH4lP+lB+z7I1akiFge9s364T
wZPJTacvDtCD/3RQAAABlTZWJhc3RpYW5AREVTS1RPUC1GMUowTVJS
-----END OPENSSH PRIVATE KEY-----
</code></pre><p>You can also use <code>local.json</code> to override these on specific machines.</p><p>For example, on our server Nexus, our Technical Support Group writes certificates to <code>/root/cert</code>, so all Ubiq Server instances have a <code>local.json</code> configuration file that point to these:</p><pre><code>{
    &quot;roomserver&quot;:
    {
        &quot;wss&quot;:
        {
            &quot;cert&quot;: &quot;/root/nexus.crt&quot;,
            &quot;key&quot;: &quot;./root/nexus.key&quot;
        }
    }
}
</code></pre><p>Note that even though the naming convention & file extensions are different, the key is in the PEM format.</p><p>Once the certificate and key have been provided, the <code>WrappedSecureWebSocketServer</code> class uses them to serve a secure websocket server using an instance of <a href=https://nodejs.org/api/https.html><code>https</code></a>.</p><pre><code>const server = createServer({
	cert: fs.readFileSync(certPath),
	key: fs.readFileSync(keyPath)
},
(req, res) =&gt; {
	res.writeHead(200);
	res.end('Welcome to Ubiq! This is a Ubiq WebSocket Server. To use this endpoint, connect to it with a Ubiq Client.\n');
  }
);
const wss = new WebSockets.WebSocketServer({ server }); // Take care to use the WebSocketServer member, as the import of ws provides the WebSocket *client* type.
this.port = config.port;
server.listen(this.port);
</code></pre><p>You can try and connect to this with a regular browser, and see its HTTPS response:</p><p><a href=https://nexus.cs.ucl.ac.uk:8010>https://nexus.cs.ucl.ac.uk:8010</a></p><p>(The server will respond to HTTP requests, until it is asked to upgrade the connection to a WebSocket)</p><h2 id=adding-to-the-trust-store>Adding to the Trust Store</h2><p>Another possibility is to self-sign your own certificates. This way, you become your own Root CA.</p><p>The downside of this is that you&rsquo;ll need to add your certificate to the Root Certificate store of all instances of all platforms you want to connect from.</p><p>So, for example, each copy of Chrome that you want to connect will have to <a href=https://www.techrepublic.com/article/how-to-add-a-trusted-certificate-authority-certificate-to-chrome-and-firefox/>add your certificate to it</a> manually. You would not be able to run an in-the-wild-experiment like this, for example.</p><p>However it may be useful to run on a small set of machines internally, or for development.</p><p>You can <a href=https://devcenter.heroku.com/articles/ssl-certificate-self>use OpenSSL</a> to generate certificates for these purposes.</p><h2 id=insecure-websockets>Insecure WebSockets</h2><p>It is still possible to serve insecure WebSockets. To do this, modify <code>connections.js</code> and present the WebSocket using an instance of <code>http</code> rather than <code>https</code>.</p><p>The reason this is not supported as a configuration option is that there isn&rsquo;t really a use case for insecure WebSockets anymore! Browsers will not connect to them, and applications running natively should use TCP directly.</p><h2 id=conclusion>Conclusion</h2><p>Browsers are defaulting to ever more restrictive content policies.</p><p>This is to make the web as safe as possible for regular users, but it does introduce complexity when offering web services.</p><p>If you want WebGL users to make connections to your own Ubiq server, the easiest way is to allow them to operate within their policies and make secure connections.</p><p>Making it easy to comply with these new requirements, and so ensuring the maximum number of administrators do, is an important part of making sure best practicies are adopted.</p><p>This is one of the motivations of Lets Encrypt, a non-profit providing free, automatic certificates to reduce the barriers to providing secure options.</p><p>For our part, the latest version of the Ubiq server offers Secure WebSockets by default. All users need to do is provide a certificate and private key for the machine they want to host it on.</p><p>And of course, if you don&rsquo;t want to provide WebSocket support, you don&rsquo;t have to do anything!</p><p>When starting the example server, it will detect if no certificate has been provided and simply not offer WebSockets. It will continue to function normally for all native (PC, Android, Quest, etc) peers out-of-the-box.</p><p>And as always, do reach out to the team via e-mail or <a href=https://github.com/UCL-VR/ubiq/discussions>Github</a> with any questions!</p></article></div></div></div></div><section class="section section-sm mt-n5 mb-3"><div class=container><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"></div></div></div></section><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline><li class=list-inline-item><a href=/privacy-policy/>Privacy</a></li></ul></div></div></div></footer><script data-goatcounter=https://ubiq.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<script src=/js/bootstrap.min.fdbe9b9ba88a036135318f3c721784d684ac9e3280fe282cc80d7d49f7f9c82780cd54228c1608685a230c09984300d7946fc471734d566fcebc148b65bd16db.js integrity="sha512-/b6bm6iKA2E1MY88cheE1oSsnjKA/igsyA19Sff5yCeAzVQijBYIaFojDAmYQwDXlG/EcXNNVm/OvBSLZb0W2w==" crossorigin=anonymous defer></script>
<script src=/js/highlight.min.2a3ca603c4e5468838fb437bc036b9ddc036b6668b5dd45804f048229ea684f98f5928dd485b41db90e55aaa28b36600341f082d2726650a0a394250b6bf3ac1.js integrity="sha512-KjymA8TlRog4+0N7wDa53cA2tmaLXdRYBPBIIp6mhPmPWSjdSFtB25DlWqoos2YANB8ILScmZQoKOUJQtr86wQ==" crossorigin=anonymous defer></script>
<script src=/main.min.7692813ef22de5d343339990192d5774c0742a9334f8f57bb78245f5ab0e02861e3e47e7308e649ca0173ef9e307477de2769299fdb90a9e4a5e327df94553b7.js integrity="sha512-dpKBPvIt5dNDM5mQGS1XdMB0KpM0+PV7t4JF9asOAoYePkfnMI5knKAXPvnjB0d94naSmf25Cp5KXjJ9+UVTtw==" crossorigin=anonymous defer></script></body></html>