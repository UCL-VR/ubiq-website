<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://ubiq.online/fonts/vendor/nunito-sans/nunito-sans-v11-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://ubiq.online/fonts/vendor/nunito/nunito-v22-latin-700.woff2 type=font/woff2 crossorigin><script integrity="sha512-RBYr6Ld4w1yVqaACrgrBLQfPgGhj/1jyacA74WxJ1KM6KVcSWymwrdDwb3HDcdpwiNJ5yssot1He0U9vXoQVlg==">(()=>{var b=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,a=localStorage.getItem("theme");b&&a===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),b&&a==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),a==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=/main.2d475f10e5b9f77c78db0bede08bfbe837a2fac3248bf7fbfede3aaefe3d93e1921d6fb9a8a6f0812476f859cdbc75077c1e84ae61e1f32892e3789e3f76ddea.css integrity="sha512-LUdfEOW593x42wvt4Iv76Dei+sMki/f7/t46rv49k+GSHW+5qKbwgSR2+FnNvHUHfB6ErmHh8yiS43ieP3bd6g==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Extending the server Ubiq</title><meta name=description content="Subclassing the Room type to implement new multicasting behaviour"><link rel=canonical href=https://ubiq.online/blog/extending-the-server/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Extending the server"><meta property="og:description" content="Subclassing the Room type to implement new multicasting behaviour"><meta property="og:url" content="https://ubiq.online/blog/extending-the-server/"><meta property="og:site_name" content="Ubiq"><meta property="article:published_time" content="2022-11-07T09:19:42+01:00"><meta property="article:modified_time" content="2023-12-07T14:13:46+00:00"><meta property="og:image:width" content="1280"><meta property="og:image:height" content="640"><meta property="og:image:alt" content="Extending the server"><meta property="og:image" content="https://ubiq.online/images/banner.png"><meta property="og:image:width" content="1280"><meta property="og:image:height" content="640"><meta property="og:image:alt" content="Ubiq"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="Extending the server"><meta name=twitter:description content="Subclassing the Room type to implement new multicasting behaviour"><meta name=twitter:image content><meta name=twitter:image:alt content="Extending the server"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://ubiq.online/#/schema/organization/1","name":"Ubiq","url":"https://ubiq.online/","sameAs":["https://github.com/UCL-VR/ubiq"],"logo":{"@type":"ImageObject","@id":"https://ubiq.online/#/schema/image/1","url":"https://ubiq.online/images/logos/ubiq-logo.png","width":512,"height":512,"caption":"Ubiq"},"image":{"@id":"https://ubiq.online/#/schema/image/1"}},{"@type":"WebSite","@id":"https://ubiq.online/#/schema/website/1","url":"https://ubiq.online/","name":"Ubiq","description":"A Unity networking library for research, teaching and development, maintained by the Virtual Environments and Computer Graphics group at UCL. Ubiq is 100% free and open source.","publisher":{"@id":"https://ubiq.online/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://ubiq.online/blog/extending-the-server/","url":"https://ubiq.online/blog/extending-the-server/","name":"Extending the server","description":"Subclassing the Room type to implement new multicasting behaviour","isPartOf":{"@id":"https://ubiq.online/#/schema/website/1"},"about":{"@id":"https://ubiq.online/#/schema/organization/1"},"datePublished":"2022-11-07T09:19:42CET","dateModified":"2023-12-07T14:13:46CET","breadcrumb":{"@id":"https://ubiq.online/blog/extending-the-server/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://ubiq.online/blog/extending-the-server/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://ubiq.online/blog/extending-the-server/"]}]},{"@type":"BreadcrumbList","@id":"https://ubiq.online/blog/extending-the-server/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://ubiq.online/","url":"https://ubiq.online/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://ubiq.online/blog/","url":"https://ubiq.online/blog/","name":"Blog"}},{"@type":"ListItem","position":3,"item":{"@id":"https://ubiq.online/blog/extending-the-server/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://ubiq.online/#/schema/article/1","headline":"Extending the server","description":"Subclassing the Room type to implement new multicasting behaviour","isPartOf":{"@id":"https://ubiq.online/blog/extending-the-server/"},"mainEntityOfPage":{"@id":"https://ubiq.online/blog/extending-the-server/"},"datePublished":"2022-11-07T09:19:42CET","dateModified":"2023-12-07T14:13:46CET","author":{"@id":"https://ubiq.online/#/schema/person/2"},"publisher":{"@id":"https://ubiq.online/#/schema/organization/1"},"image":{"@id":"https://ubiq.online/blog/extending-the-server/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://ubiq.online/#/schema/person/2","name":"Nels Numan","sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://ubiq.online/blog/extending-the-server/#/schema/image/2","url":null,"contentUrl":null,"width":1826,"height":874,"caption":"Extending the server"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://ubiq.online/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://ubiq.online/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://ubiq.online/favicon-16x16.png><link rel=manifest href=https://ubiq.online/site.webmanifest></head><body class="single section blog"><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=/ aria-label=Bootstrap>Ubiq</a>
<button class="btn btn-menu d-block d-md-none order-5" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-start border-0 py-md-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-md-none"></div><div class="offcanvas-header d-md-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>Ubiq</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body px-4"><h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3><ul class="nav flex-column flex-md-row ms-md-n3"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://ucl-vr.github.io/ubiq/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/showcase/>Showcase</a></li><li class=nav-item><a class="nav-link ps-0 py-1 active" href=/blog/>Blog</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/publication/>Publications</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/teaching>Teaching</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Contact
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=https://github.com/UCL-VR/ubiq/discussions/categories/q-a>â†— Ask a Question</a></li><li><a class=dropdown-item href=/contributors/>Contributors</a></li><li><a class=dropdown-item href=/media/>Media</a></li></ul></li></ul><hr class="text-black-50 my-4 d-md-none"><h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3><ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://discord.gg/cZYzdcxAAB><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 128 128" fill="#000" stroke="currentcolor" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-discord"><path d="M45.23 57.2c-6.16.0-11.17 5.6-11.17 12.48s5 12.47 11.17 12.47 11.16-5.59 11.16-12.47S51.38 57.2 45.23 57.2zm0 21c-4 0-7.17-3.8-7.17-8.47s3.21-8.48 7.17-8.48 7.16 3.8 7.16 8.48-3.21 8.42-7.16 8.42z"/><path d="M121.83 59.58a156.78 156.78.0 00-11.52-31 2.1 2.1.0 00-.71-.77 87.08 87.08.0 00-15.23-7.17C84.55 17.07 79.91 17 79.72 17a2 2 0 00-2 1.72l-.6 4.17a133.14 133.14.0 00-26.28.0l-.6-4.17a2 2 0 00-2-1.72c-.19.0-4.83.0-14.65 3.61A87.08 87.08.0 0018.4 27.81a2.1 2.1.0 00-.71.77 156.72 156.72.0 00-11.52 31C1 80.46.0 90.91.0 91.34a2 2 0 00.49 1.5 55.2 55.2.0 0018.2 12.74A76.32 76.32.0 0038.48 111a2 2 0 001.92-1l5.4-9.25A105.08 105.08.0 0064 102.24a105.08 105.08.0 0018.2-1.51L87.6 110a2 2 0 001.72 1h.2a76.32 76.32.0 0019.78-5.38 55.2 55.2.0 0018.2-12.74 2 2 0 00.49-1.5C128 90.91 127.05 80.46 121.83 59.58zm-14.06 42.31a76.76 76.76.0 01-17.39 4.92l-4.08-7c4.68-1.24 14.42-4.46 21.83-11.2a2 2 0 10-2.69-3c-9 8.23-22.46 10.84-22.6 10.87h-.06A96.59 96.59.0 0164 98.24a96.59 96.59.0 01-18.78-1.7h-.06c-.14.0-13.55-2.64-22.6-10.87a2 2 0 10-2.69 3c7.41 6.74 17.15 10 21.83 11.2l-4.08 7a76.08 76.08.0 01-17.39-4.92A52.24 52.24.0 014.08 90.8c.33-2.91 1.68-13.07 6-30.24A156.25 156.25.0 0121 30.92 88.17 88.17.0 0135 24.4a61.35 61.35.0 0111.58-3.19l.35 2.39c-4 1-13.85 3.86-21.65 9.53a2 2 0 102.36 3.23c8.82-6.41 21-9.06 21.86-9.25A118.4 118.4.0 0164 26.27a117.64 117.64.0 0114.51.84c.91.19 13 2.83 21.86 9.25a2 2 0 102.36-3.23c-7.8-5.67-17.61-8.52-21.65-9.53l.35-2.39A61.75 61.75.0 0193 24.4a88.17 88.17.0 0114 6.52 156.25 156.25.0 0111 29.64c4.29 17.17 5.64 27.33 6 30.24a52.24 52.24.0 01-16.23 11.09z"/><path d="M82.77 57.2c-6.15.0-11.16 5.6-11.16 12.48s5 12.47 11.16 12.47 11.17-5.59 11.17-12.47S88.93 57.2 82.77 57.2zm0 21c-4 0-7.16-3.8-7.16-8.47s3.21-8.48 7.16-8.48 7.17 3.8 7.17 8.48S86.73 78.15 82.77 78.15z"/></svg><small class="ms-2 d-md-none">Discord</small></a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://github.com/UCL-VR/ubiq/><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div><button id=mode class="btn btn-link order-md-1" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></nav></header><div class="wrap container-xxl" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>Extending the server</h1><p><small>Posted November 7, 2022 by <a class="stretched-link position-relative" href=/contributors/sebastian-friston/>Sebastian Friston</a>&nbsp;&dash;&nbsp;<strong>7&nbsp;min read</strong></small><p></div><p class=lead>See how the servers new extensibility methods allow you to implement your own multicasting models for research and experimentation.</p><h2 id=introduction>Introduction</h2><p>Ubiq sessions are made up of Peers connected in a <em>Peer Group</em>.</p><p>By default, peers join <em>Rooms</em> on the server. Each room is a peer group, and group members exchange all messages with all other members.</p><p>This is just one possibility however&mldr;</p><p>In this post we show how to extend the server without making upstream code changes, so we can implement different multicasting behaviours, and so build different peer groups, for research and experimentation.</p><h2 id=peers-and-peer-groups>Peers and Peer Groups</h2><p>A peer group is defined as the set of peers who exchange messages - i.e. when a message is sent by one peer, which other peers recieve it.</p><p>When using the server, all peers make a connection to one process, and this process forwards messages between the connections. How these messages are forwarded - which peers they are forward to - defines the peer group.</p><p>The most common case is that peers use a <code>RoomClient</code> to join a <em>Room</em>, and the server forwards all messages between all members of a room.</p><p>In our recent scalability paper (under review), we compared two alternative ways to build peer groups - both based on peer locations.
One partitioned the world into a set of cells, and the other made a group for each Peer out of the <em>k</em>-nearest other Peers.</p><h2 id=extending-the-server>Extending the server</h2><p>The Ubiq server is delivered as plain Javascript, so it is straightforward (and encouraged!) to modify it directly.</p><p>For simplicitly however, the server has patterns with extensibility in mind&mldr;</p><h3 id=rooms>Rooms</h3><p>When the server starts up in <code>app.js</code>, it creates a new <code>RoomServer</code> class and adds some listening sockets to it.
When peers make connections to one of these sockets, a new connection is created and wrapped by a <code>RoomPeer</code> instance.</p><p><code>RoomPeer</code> parses the messages from the peer&rsquo;s Room Client and arranges for the Room Peer to join a room.</p><pre><code>onConnection(wrapped){
	console.log(&quot;RoomServer: Client Connection from &quot; + wrapped.endpoint().address + &quot;:&quot; + wrapped.endpoint().port);
	new RoomPeer(this, wrapped);
}
</code></pre><p>Rooms are represented by objects which contain lists of their members. Object instances are created on-demand. The class itself determines how messages should be forwarded between the members.</p><p>By default, the Room Server will create rooms of type <code>Room</code>. This type forwards all messages, to all members:</p><pre><code>processMessage(source, message){
	this.peers.forEach(peer =&gt;{
		if(peer != source){
			peer.send(message);
		}
	});
}
</code></pre><p>However, it&rsquo;s possible to tell <code>RoomServer</code> to use a different class.</p><h3 id=subclassing-room>Subclassing Room</h3><p>In this example, we will add a new room type that creates groups of k-nearest neighbours.</p><ol><li><p>Create a new class in a new file, e.g. <code>knnroom.js</code>.</p></li><li><p>In this new file, import <code>Room</code> so we can subclass it. <code>Room</code> implements a number of methods that <code>RoomServer</code> expects, so it&rsquo;s easiest to subclass it, though you can always copy it and modify the copy instead.</p></li></ol><pre><code>	const { Room } = require(&quot;./rooms&quot;)
	class KnnRoom extends Room{
		constructor(server){
			super(server);
		}
	}
</code></pre><ol start=3><li><p>Implement the new multicasting behaviour. There are a few important methods you&rsquo;ll need to consider for this&mldr;</p><p>a. <code>addPeer</code> is called when a peer joins the room. In our subclass we put the peer in a list as before, but this list is no longer used to forward messages directly. Instead each peer is given its own set of arrays to maintain.</p><pre><code> addPeer(peer){
 	peer.kNearestPeers = [];
 	peer.kNearestPeerTimeouts = {};
 	peer.kObservers = [];

 	this.peers.push(peer);
 	peer.setRoom(this);
 }
</code></pre><p>b. <code>broadcastPeerProperties</code> is called when a peer updates its <em>Peer Dictionary</em>.</p><p>This is how we can get information to our subclass without implementing a new <code>RoomClient</code> message.
We check for the existence of a particular key and parse it, before handing control back to the superclass.</p><pre><code> broadcastPeerProperties(peer,keys,values){
 	// Intercept the position member
 	var i = keys.indexOf(&quot;x.scalability.position&quot;);
 	if(i &gt; -1){
 		var position = values[i];
 		peer.position = JSON.parse(position);
 	}
 	super.broadcastPeerProperties(peer, keys, values);
 }
</code></pre><p>In the snippet above, peers send their positions in the new key, and these are stored as vectors on the <code>RoomPeer</code> objects.</p><p>In Unity, the key is set with a dedicated Component:</p><pre><code> IEnumerator PositionUpdate()
 {
 	while (true)
 	{
 		roomClient.Me[&quot;x.scalability.position&quot;] = JsonUtility.ToJson(PlayerTransform.position);
 		yield return new WaitForSeconds(0.1f);
 	}
 }
</code></pre><p>c. In the constructor, we add the configuration for our subclass. Here we also, start an interval timer so we can get the subclass to call an update method at regular intervals.</p><pre><code> class KnnRoom extends Room{
 	constructor(server){
 		super(server);
 		this.k = 20;
 		setInterval(this.updateNearest.bind(this), 200);
 	}
 }
</code></pre><p>In <code>KnnRoom</code>, we compute the set of k-nearest neightbours for each peer, updating their <code>kNearestPeers</code> arrays.</p><pre><code> async updateNearestPeers(me){ // me is the peer

 	// Get a list of other peers closest to this peer

 	var peerDistances = [];
 	this.peers.forEach(peer =&gt; {
 		if(peer != me){
 			if(peer.position !== undefined &amp;&amp; me.position !== undefined){
 				peerDistances.push({
 					peer: peer,
 					distance: KnnRoom.distance(peer.position, me.position)
 				})
 			}
 		}
 	});

 	peerDistances.sort((a,b) =&gt;{
 		return a.distance - b.distance;
 	});

 	var nearest = peerDistances.slice(0, this.k).map(d =&gt; d.peer);

 	// intersect to find who we have to drop, and who we have to add 

 	var added = nearest.filter(x =&gt; !me.kNearestPeers.includes(x));
 	var removed = me.kNearestPeers.filter(x =&gt; !nearest.includes(x));

 	added.forEach(peer =&gt;{
 		me.kNearestPeers.push(peer);
 		me.sendPeerAdded(peer);
 		peer.kObservers.push(me); // add me to observers of the other peer, so I get its messages even if // I am not in its k-nearest group..
 	});

 	removed.forEach(peer =&gt;{
 		me.kNearestPeers.splice(me.kNearestPeers.indexOf(peer),1);
 		me.sendPeerRemoved(peer); 
 		peer.kObservers.splice(peer.kObservers.indexOf(me), 1); // remove me from observer of the other peer, as I am no longer interested in it. If it needs my messages, it will be in my observers group.
 	});

 }
</code></pre><p>d. <code>processMessage</code> (finally!) is the most important method. This is called whenever a peer sends a message to the peer group - it is here that the multicasting takes place.</p><pre><code> processMessage(source, message){
 	source.kObservers.forEach(other =&gt;{
 		other.send(message);
 	})
 }
</code></pre><p>In <code>KnnRoom</code>, the logic turns out to be very simple, as all the work to define the peer group takes place in the <code>updateNearestPeers</code> method.</p><p>Note how in the snippet above, we are actually forwarding to the <code>kObservers</code> array. This is the array of peers for which the peer sending the message is one of the <em>k</em>-closest other peers.
The peer will be in the <code>kObservers</code> array of all the peers in its own <code>kNearestPeers</code> array.</p></li><li><p>Now we have the new class, we must tell the <code>RoomServer</code> to use it. Make sure the class is visible by importing it somewhere into the <code>app.js</code>,</p><p><code>const { KnnRoom } = require("./knnroom");</code></p></li><li><p>Then, modify the server config to specify the name of the new type,</p></li></ol><pre><code>	{
		&quot;roomserver&quot;:
		{
			&quot;ports&quot;:
			{
				&quot;tcp&quot;: 8009,
			},
			&quot;roomType&quot;:&quot;KnnRoom&quot;
		}
	}
</code></pre><p>Now, when <code>RoomServer</code> needs to create a room, it will create a <code>KnnRoom</code> instead of a <code>Room</code>.</p><p>Any number of peers can join a single room, and <code>KnnRoom</code> will multicast within it based on the relative positions of the peers.</p><h3 id=server-messages>Server Messages</h3><p>In the example above, we used the peer dictionary to communicate with our subclass, but we can send messages directly too.</p><p>By default, messages addressed to the Room Server are parsed by <code>RoomPeer</code>, which is the counterpart of <code>RoomClient</code>.</p><p>If a message is addressed to the Room Server but does not match an existing message type however, it is forwarded to the room itself.</p><p>This is done through the <code>processRoomMessage(message)</code> method, with <em>message</em> having the schema:</p><pre><code>{
    id: &quot;/ubiq.rooms.servermessage&quot;,
    type: &quot;object&quot;,
    properties: {
        type: {&quot;type&quot;: &quot;string&quot;},
        args: {&quot;type&quot;: &quot;string&quot;}
    },
    required: [&quot;type&quot;,&quot;args&quot;]
}
</code></pre><p>This functionality makes it possible for additional components to address the subclass directly.</p><p>For example, the following snippet uses a new message type, <code>SetObserved</code>, to maintain a second list of peers.</p><pre><code>class MyExtendedRoom extends Room{
	// Forwarded to this room when the Peer sends a message to the server with an unknown Type
	processRoomMessage(peer, message){
		switch(message.type){
			case &quot;SetObserved&quot;:
				this.changeObserved(peer, message.args.rooms);
				break;
		}
	}
}
</code></pre><p>In Unity, the RoomClient includes a public method, <code>SendToServer</code>, which can be used to send arbitrary messages intended to be picked up this way.</p><pre><code>public class MyRoomAgent : MonoBehaviour
{
	private struct SetObservedRequest
	{
		public List&lt;string&gt; rooms;
	}

	/// &lt;summary&gt;
	/// Observes the Rooms with the specified Guids. Stops observing any not in the list, and begins observing any new ones.
	/// &lt;/summary&gt;
	void SetObserved(List&lt;Guid&gt; guids)
	{
		roomClient.SendToServer(
			new Messages.Message(
				&quot;SetObserved&quot;, 
				new SetObservedRequest()
				{
					rooms = guids.Select(g =&gt; g.ToString()).ToList()
				})
			);
	}
}
</code></pre><h2 id=conclusion>Conclusion</h2><p>A cornerstone of Ubiq is its peer-to-peer messaging based on <em>groups</em>. Groups are the peers that receive messages sent by one of their members.</p><p>By changing how messages are forwarded, we change the groups, and possibly the behaviour of users or an application.</p><p>To experiment with different models for groups, you can subclass the type that is responsible for multicasting and implment your own models, without making any changes to the Ubiq code.</p><p>To get the complete code for the above examples, and check out how these features were used in some our own experiments, have a look at the <a href=https://github.com/UCL-VR/ubiq/tree/ubiq-scalability-2022>ubiq-scalability-2022</a> branch.</p></article></div></div></div></div><section class="section section-sm mt-n5 mb-3"><div class=container><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"></div></div></div></section><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline><li class=list-inline-item><a href=/privacy-policy/>Privacy</a></li></ul></div></div></div></footer><script data-goatcounter=https://ubiq.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<script src=/js/bootstrap.min.fdbe9b9ba88a036135318f3c721784d684ac9e3280fe282cc80d7d49f7f9c82780cd54228c1608685a230c09984300d7946fc471734d566fcebc148b65bd16db.js integrity="sha512-/b6bm6iKA2E1MY88cheE1oSsnjKA/igsyA19Sff5yCeAzVQijBYIaFojDAmYQwDXlG/EcXNNVm/OvBSLZb0W2w==" crossorigin=anonymous defer></script>
<script src=/js/highlight.min.2a3ca603c4e5468838fb437bc036b9ddc036b6668b5dd45804f048229ea684f98f5928dd485b41db90e55aaa28b36600341f082d2726650a0a394250b6bf3ac1.js integrity="sha512-KjymA8TlRog4+0N7wDa53cA2tmaLXdRYBPBIIp6mhPmPWSjdSFtB25DlWqoos2YANB8ILScmZQoKOUJQtr86wQ==" crossorigin=anonymous defer></script>
<script src=/main.min.7692813ef22de5d343339990192d5774c0742a9334f8f57bb78245f5ab0e02861e3e47e7308e649ca0173ef9e307477de2769299fdb90a9e4a5e327df94553b7.js integrity="sha512-dpKBPvIt5dNDM5mQGS1XdMB0KpM0+PV7t4JF9asOAoYePkfnMI5knKAXPvnjB0d94naSmf25Cp5KXjJ9+UVTtw==" crossorigin=anonymous defer></script></body></html>