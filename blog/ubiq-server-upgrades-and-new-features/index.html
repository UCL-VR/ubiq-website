<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://ubiq.online/fonts/vendor/nunito-sans/nunito-sans-v11-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://ubiq.online/fonts/vendor/nunito/nunito-v22-latin-700.woff2 type=font/woff2 crossorigin><script integrity="sha512-RBYr6Ld4w1yVqaACrgrBLQfPgGhj/1jyacA74WxJ1KM6KVcSWymwrdDwb3HDcdpwiNJ5yssot1He0U9vXoQVlg==">(()=>{var b=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,a=localStorage.getItem("theme");b&&a===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),b&&a==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),a==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=/main.be2ac79d46942b3c1be9b102cb3f8714a31099e650d6d5c9d08f182ec3ddb8f751c2564f2274fddc98ae819330a1da887d17d15f3991255d9d7bf58ae0f3ed4f.css integrity="sha512-virHnUaUKzwb6bECyz+HFKMQmeZQ1tXJ0I8YLsPduPdRwlZPInT93JiugZMwodqIfRfRXzmRJV2de/WK4PPtTw==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Ubiq Server Upgrades and New Features Ubiq</title><meta name=description content="Details about our upgrade of the Ubiq Server Modules to TypeScript and other improvements"><link rel=canonical href=https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Ubiq Server Upgrades and New Features"><meta property="og:description" content="Details about our upgrade of the Ubiq Server Modules to TypeScript and other improvements"><meta property="og:url" content="https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/"><meta property="og:site_name" content="Ubiq"><meta property="article:published_time" content="2023-11-24T09:19:42+01:00"><meta property="article:modified_time" content="2024-04-19T14:41:49+01:00"><meta property="og:image:width" content="1280"><meta property="og:image:height" content="640"><meta property="og:image:alt" content="Ubiq Server Upgrades and New Features"><meta property="og:image" content="https://ubiq.online/images/banner.png"><meta property="og:image:width" content="1280"><meta property="og:image:height" content="640"><meta property="og:image:alt" content="Ubiq"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="Ubiq Server Upgrades and New Features"><meta name=twitter:description content="Details about our upgrade of the Ubiq Server Modules to TypeScript and other improvements"><meta name=twitter:image content><meta name=twitter:image:alt content="Ubiq Server Upgrades and New Features"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://ubiq.online/#/schema/organization/1","name":"Ubiq","url":"https://ubiq.online/","sameAs":["https://github.com/UCL-VR/ubiq"],"logo":{"@type":"ImageObject","@id":"https://ubiq.online/#/schema/image/1","url":"https://ubiq.online/images/logos/ubiq-logo.png","width":512,"height":512,"caption":"Ubiq"},"image":{"@id":"https://ubiq.online/#/schema/image/1"}},{"@type":"WebSite","@id":"https://ubiq.online/#/schema/website/1","url":"https://ubiq.online/","name":"Ubiq","description":"A Unity networking library for research, teaching and development, maintained by the Virtual Environments and Computer Graphics group at UCL. Ubiq is 100% free and open source.","publisher":{"@id":"https://ubiq.online/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/","url":"https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/","name":"Ubiq Server Upgrades and New Features","description":"Details about our upgrade of the Ubiq Server Modules to TypeScript and other improvements","isPartOf":{"@id":"https://ubiq.online/#/schema/website/1"},"about":{"@id":"https://ubiq.online/#/schema/organization/1"},"datePublished":"2023-11-24T09:19:42CET","dateModified":"2024-04-19T14:41:49CET","breadcrumb":{"@id":"https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/"]}]},{"@type":"BreadcrumbList","@id":"https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://ubiq.online/","url":"https://ubiq.online/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://ubiq.online/blog/","url":"https://ubiq.online/blog/","name":"Blog"}},{"@type":"ListItem","position":3,"item":{"@id":"https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://ubiq.online/#/schema/article/1","headline":"Ubiq Server Upgrades and New Features","description":"Details about our upgrade of the Ubiq Server Modules to TypeScript and other improvements","isPartOf":{"@id":"https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/"},"mainEntityOfPage":{"@id":"https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/"},"datePublished":"2023-11-24T09:19:42CET","dateModified":"2024-04-19T14:41:49CET","author":{"@id":"https://ubiq.online/#/schema/person/2"},"publisher":{"@id":"https://ubiq.online/#/schema/organization/1"},"image":{"@id":"https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://ubiq.online/#/schema/person/2","name":"Nels Numan","sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/#/schema/image/2","url":null,"contentUrl":null,"width":1826,"height":874,"caption":"Ubiq Server Upgrades and New Features"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://ubiq.online/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://ubiq.online/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://ubiq.online/favicon-16x16.png><link rel=manifest href=https://ubiq.online/site.webmanifest></head><body class="single section blog"><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=/ aria-label=Bootstrap>Ubiq</a>
<button class="btn btn-menu d-block d-md-none order-5" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-start border-0 py-md-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-md-none"></div><div class="offcanvas-header d-md-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>Ubiq</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body px-4"><h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3><ul class="nav flex-column flex-md-row ms-md-n3"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://ucl-vr.github.io/ubiq/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/showcase/>Showcase</a></li><li class=nav-item><a class="nav-link ps-0 py-1 active" href=/blog/>Blog</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/publication/>Publications</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/teaching>Teaching</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Contact
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=https://github.com/UCL-VR/ubiq/discussions/categories/q-a>â†— Ask a Question</a></li><li><a class=dropdown-item href=/contributors/>Contributors</a></li><li><a class=dropdown-item href=/media/>Media</a></li></ul></li></ul><hr class="text-black-50 my-4 d-md-none"><h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3><ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://discord.gg/cZYzdcxAAB><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 128 128" fill="#000" stroke="currentcolor" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-discord"><path d="M45.23 57.2c-6.16.0-11.17 5.6-11.17 12.48s5 12.47 11.17 12.47 11.16-5.59 11.16-12.47S51.38 57.2 45.23 57.2zm0 21c-4 0-7.17-3.8-7.17-8.47s3.21-8.48 7.17-8.48 7.16 3.8 7.16 8.48-3.21 8.42-7.16 8.42z"/><path d="M121.83 59.58a156.78 156.78.0 00-11.52-31 2.1 2.1.0 00-.71-.77 87.08 87.08.0 00-15.23-7.17C84.55 17.07 79.91 17 79.72 17a2 2 0 00-2 1.72l-.6 4.17a133.14 133.14.0 00-26.28.0l-.6-4.17a2 2 0 00-2-1.72c-.19.0-4.83.0-14.65 3.61A87.08 87.08.0 0018.4 27.81a2.1 2.1.0 00-.71.77 156.72 156.72.0 00-11.52 31C1 80.46.0 90.91.0 91.34a2 2 0 00.49 1.5 55.2 55.2.0 0018.2 12.74A76.32 76.32.0 0038.48 111a2 2 0 001.92-1l5.4-9.25A105.08 105.08.0 0064 102.24a105.08 105.08.0 0018.2-1.51L87.6 110a2 2 0 001.72 1h.2a76.32 76.32.0 0019.78-5.38 55.2 55.2.0 0018.2-12.74 2 2 0 00.49-1.5C128 90.91 127.05 80.46 121.83 59.58zm-14.06 42.31a76.76 76.76.0 01-17.39 4.92l-4.08-7c4.68-1.24 14.42-4.46 21.83-11.2a2 2 0 10-2.69-3c-9 8.23-22.46 10.84-22.6 10.87h-.06A96.59 96.59.0 0164 98.24a96.59 96.59.0 01-18.78-1.7h-.06c-.14.0-13.55-2.64-22.6-10.87a2 2 0 10-2.69 3c7.41 6.74 17.15 10 21.83 11.2l-4.08 7a76.08 76.08.0 01-17.39-4.92A52.24 52.24.0 014.08 90.8c.33-2.91 1.68-13.07 6-30.24A156.25 156.25.0 0121 30.92 88.17 88.17.0 0135 24.4a61.35 61.35.0 0111.58-3.19l.35 2.39c-4 1-13.85 3.86-21.65 9.53a2 2 0 102.36 3.23c8.82-6.41 21-9.06 21.86-9.25A118.4 118.4.0 0164 26.27a117.64 117.64.0 0114.51.84c.91.19 13 2.83 21.86 9.25a2 2 0 102.36-3.23c-7.8-5.67-17.61-8.52-21.65-9.53l.35-2.39A61.75 61.75.0 0193 24.4a88.17 88.17.0 0114 6.52 156.25 156.25.0 0111 29.64c4.29 17.17 5.64 27.33 6 30.24a52.24 52.24.0 01-16.23 11.09z"/><path d="M82.77 57.2c-6.15.0-11.16 5.6-11.16 12.48s5 12.47 11.16 12.47 11.17-5.59 11.17-12.47S88.93 57.2 82.77 57.2zm0 21c-4 0-7.16-3.8-7.16-8.47s3.21-8.48 7.16-8.48 7.17 3.8 7.17 8.48S86.73 78.15 82.77 78.15z"/></svg><small class="ms-2 d-md-none">Discord</small></a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://github.com/UCL-VR/ubiq/><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div><button id=mode class="btn btn-link order-md-1" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></nav></header><div class="wrap container-xxl" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>Ubiq Server Upgrades and New Features</h1><p><small>Posted November 24, 2023 by <a class="stretched-link position-relative" href=/contributors/sebastian-friston/>Sebastian Friston</a>&nbsp;&dash;&nbsp;<strong>9&nbsp;min read</strong></small><p></div><p class=lead>The Ubiq server has been updated, with a number of new features. Learn about the recent changes we have made and why.</p><p>We have just released a major update to our Node platform code. This encompasses the server, and JavaScript modules for use in the Browser.</p><p>This update includes an upgrade to TypeScript, new unit tests, a new status module and a number of other quality of life improvements.</p><p>The server API remains unchanged, so this upgrade has already been applied in-place and transparently. If you do not write code for the server, you will not need to do anything.</p><p>If you do however, this post explains each change in detail, and what it means for you as a developer.</p><h2 id=typescript>TypeScript</h2><p>The most visible change is that our JavaScript code is now written in <a href=https://www.typescriptlang.org/>TypeScript</a>.</p><p>TypeScript adds type annotation to JavaScript. This allows catching errors earlier and improves the self-documenting capacity of the code. It also allows improved schema validation for better runtime stability.</p><p>All of the code in the Node platform folder has been updated: the Ubiq, Server modules and Components packages. The only exception are the two sample Node Peer applications.</p><p>We would like to thank <a href=https://github.com/TheBv>TheBv</a> for contributing the bulk of these changes to the server.</p><h3 id=ts-node>ts-node</h3><p>The project uses Node&rsquo;s <a href=https://dev.to/jakobjingleheimer/custom-esm-loaders-who-what-when-where-why-how-4i1o>loaders</a> feature to enable Node to execute TypeScript directly.</p><p>For the majority of developers, your user story is unchanged. The browser samples also work identically to before.</p><p>The only breaking change is that the server can no longer be started simply via &ldquo;node app.js&rdquo;, but instead, by:</p><pre><code>node --loader ts-node/esm app.ts
</code></pre><p>or</p><pre><code>NODE_OPTIONS=&quot;--loader ts-node/esm&quot;
node app.ts
</code></pre><p>or</p><pre><code>npm start
</code></pre><p>This is because TypeScript is its own language. Normally TypeScript is compiled to JavaScript, and then that JavaScript is executed.</p><p>ts-node hides this by transpiling in real-time. This avoids the need for an additional build step or build artefacts to keep in sync, and permits debugging against the original TypeScript file.</p><p>You can also set the <code>NODE_OPTIONS</code> environment variable system wide.</p><p><code>npm start</code> is possible because the <code>package.json</code> has been given a <a href=https://www.knowledgehut.com/blog/web-development/package-json-scripts-node-js>script</a> <code>start</code> which is simply a shortcut to <code>node --loader ts-node/esm app.ts</code>.</p><p>Using <code>npm start</code> is the recommended way to start the server now, as the script entry can be updated behind the scenes to encompass any future changes.</p><h3 id=vscode>VSCode</h3><p>In VSCode, the recommended launch config for the server looks like:</p><pre><code>{
	&quot;type&quot;: &quot;pwa-node&quot;,
	&quot;request&quot;: &quot;launch&quot;,
	&quot;name&quot;: &quot;Launch Server&quot;,
	&quot;skipFiles&quot;: [
		&quot;&lt;node_internals&gt;/**&quot;
	],
	&quot;env&quot;: {&quot;NODE_OPTIONS&quot;: &quot;--loader ts-node/esm&quot;},
	&quot;program&quot;: &quot;${workspaceFolder}\\app.ts&quot;,
	&quot;console&quot;: &quot;integratedTerminal&quot;
}
</code></pre><h3 id=pm2>PM2</h3><p><code>npm start</code> works with <a href=https://pm2.keymetrics.io/>pm2</a>.</p><p>The way a the server process is created on nexus, for example, is:</p><pre><code>pm2 start npm -- name &quot;ubiq-server&quot; -- start
</code></pre><p>Where &ldquo;ubiq-server&rdquo; is the app name, which can be anything you like.</p><h3 id=package-extensions>Package Extensions</h3><p>When writing a package&rsquo;s <code>index.ts</code> file, the extensions of the imports must be .js, even though the files on disk are .ts.</p><p>For example, the <code>index.ts</code> for the Modules package contains&mldr;</p><pre><code>export { IceServerProvider } from './ice.js' // The extension must be .js even though the files on disk are .ts
export { RoomServer } from './roomserver.js'
export { Status } from './status.js'
</code></pre><p>A more detailed <a href=https://dev.to/ayc0/typescript-50-new-mode-bundler-esm-1jic>discussion of this</a> is available. Briefly however, in Ubiq we leave the extensions as .js.</p><p>The reason is that for TypeScript to accept .ts extensions, the option <code>allowImportingTsExtensions</code> must be set, but this creates issues with our bundler, Rollup.</p><p>If either changes in the future this will be updated, but it shouldn&rsquo;t affect importing or consuming modules.</p><p>You only need to keep it in mind when updating or adding new modules.</p><h2 id=zod>Zod</h2><p>One of the advantages of TypeScript is the closer integration of validation and static typing.</p><p>The server now uses <a href=https://github.com/colinhacks/zod>Zod</a> for validation. This allows defining a schema and a type in one, such as:</p><pre><code>const JoinArgs = z.object({
    joincode: z.string().optional(),
    uuid: z.string().optional(),
    name: z.string().optional(),
    publish: z.boolean(),
    peer: PeerInfo
});

type JoinArgs = z.infer&lt;typeof JoinArgs&gt;;
</code></pre><p>Note how the <code>JoinArgs</code> type and <code>JoinArgs</code> schema objects have the same name. This is possible in TypeScript because the typing universe is separate from the object universe.</p><p>Some types defined with Zod are also exported. For example, the RoomServer exports Message definitions, which are imported by the RoomClient in Components. This ensures that these types are only ever defined in one place.</p><h2 id=linting>Linting</h2><p>The project now has a linter, <a href=https://eslint.org/>ESLint</a>, installed. A linter enforces a consistent coding style, making the code more readable, and catches common errors and anti-patterns.</p><p>Linting is not performed as a discrete build step. It is expected that the IDE, such as VSCode, will warn about linting errors during development.</p><h2 id=esm-and-cjs>ESM and CJS</h2><p><a href=https://konstantin.digital/blog/es-modules-all-you-need-to-know>ECMAScript (ESM) and CommonJS (CJS)</a> are two ways to specify dependencies between JavaScript modules.</p><p>In brief, CJS considers each .js file a different module, and modules are imported using <code>require('module.js')</code>. ESM is the newer way to create modules, using a <code>package.json</code> file to describe a module consisting of a number of .js files.</p><p>ESM is standardised, and is the recommended way to do define modules going forwards.</p><p>The project now uses ESM exclusively (even in the samples that do not use TypeScript).</p><h2 id=browser-samples>Browser Samples</h2><p>The only change to the browser samples is that they now use ESM everywhere as well, whereas previously the Ubiq library would have been imported as CJS.</p><p>This means the <code>&lt;script></code> tags are unchanged, but inside each sample&rsquo;s .js file, instead of writing, say</p><p><code>import Ubiq from "/bundle.js"</code></p><p>You would now write</p><p><code>import { NetworkScene, NetworkId } from "/bundle.js"</code></p><p>And instead of creating a type from the Ubiq module</p><p><code>const scene = new Ubiq.NetworkScene()</code></p><p>You can now use the imported class directly</p><p><code>const scene = new NetworkScene()</code></p><p>The <a href=https://github.com/UCL-VR/ubiq/tree/samples-browserextended>browser samples</a> have already been updated.</p><h2 id=unit-tests>Unit Tests</h2><p>We have now introduced a set of unit tests for the libraries based on <a href=https://jestjs.io/>Jest</a>.</p><p>The tests currently cover the server modules and components.</p><p>The tests are configured to run using an existing server instance. This allows running the tests against a server to which the debugger is attached.</p><p>This means that the server must be started manually before executing the tests.</p><p>Where this server is is determined from the <code>default</code> and <code>test</code> config files. By default it assumes there is a server on <code>localhost</code>.</p><p>To execute the tests from the command line, give the command <code>npm test</code>.</p><p>We also recommend installing one of the VSCode extensions for Jest. For example, <a href="https://marketplace.visualstudio.com/items?itemName=firsttris.vscode-jest-runner">Jest Runner</a>. This allows starting a test from within the IDE under a debugger.</p><p>The project uses <a href=https://www.npmjs.com/package/ts-jest-resolver>Jest Resolver</a> to ensure Jest works with our imports (which use .js, as described above).</p><p>When making changes to the server code, the unit tests can be used to ensure there are no regression errors. We will add additional unit tests to improve coverage as time goes on.</p><h2 id=status-module>Status Module</h2><p>The server has a new module aimed at improving stability and visibility.</p><p>The status module creates a dedicated HTTP server through which basic information about the server&rsquo;s state can be established. The API can be used to poll the server for statistics, and see information about rooms. Importantly, the server has a dedicated API for uptime tests.</p><p>In the future this API will be extended with the ability to manipulate the server. For example, deleting rooms or changing properties.</p><p>The status module is written such that all the APIs are intended to be interacted with programmatically. That is, they send and receive structured JSON objects. The server runs on its own port. There is an entry in <code>default.json</code> to configure it.</p><p>Once the server is started, the API can be accessed with HTTP GET requests. For example, visiting <code>https://localhost:8011/stats</code> in a browser (with a local server running) will show a number of statistics about the server:</p><p><figure class=figure><img class="figure-img img-fluid lazyload blur-up" data-sizes=auto src=https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/stats_page_hu55fbeed21629c464bbc3382d2960ff78_52223_20x0_resize_box_3.png data-srcset="https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/stats_page_hu55fbeed21629c464bbc3382d2960ff78_52223_900x0_resize_box_3.png 900w,https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/stats_page_hu55fbeed21629c464bbc3382d2960ff78_52223_800x0_resize_box_3.png 800w,https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/stats_page_hu55fbeed21629c464bbc3382d2960ff78_52223_700x0_resize_box_3.png 700w,https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/stats_page_hu55fbeed21629c464bbc3382d2960ff78_52223_600x0_resize_box_3.png 600w,https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/stats_page_hu55fbeed21629c464bbc3382d2960ff78_52223_500x0_resize_box_3.png 500w" width=1592 height=792 alt="Scene View"><noscript><img class="figure-img img-fluid" sizes=100vw srcset="https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/stats_page_hu55fbeed21629c464bbc3382d2960ff78_52223_900x0_resize_box_3.png 900w,https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/stats_page_hu55fbeed21629c464bbc3382d2960ff78_52223_800x0_resize_box_3.png 800w,https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/stats_page_hu55fbeed21629c464bbc3382d2960ff78_52223_700x0_resize_box_3.png 700w,https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/stats_page_hu55fbeed21629c464bbc3382d2960ff78_52223_600x0_resize_box_3.png 600w,https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/stats_page_hu55fbeed21629c464bbc3382d2960ff78_52223_500x0_resize_box_3.png 500w" src=https://ubiq.online/blog/ubiq-server-upgrades-and-new-features/stats_page.png width=1592 height=792 alt="Scene View"></noscript></figure></p><h3 id=public-and-private-apis>Public and Private APIs</h3><p>Another endpoint is the rooms API: <code>https://localhost:8011/rooms</code>. This will show a list of UUIDs for all currently existing rooms. You can then give one of the UUIDs as a parameter to get more detailed information about that room, e.g. <code>https://localhost:8011/rooms/fc587165-7174-466b-89c4-cd421d235732</code>.</p><p>Being able to access room UUIDs this way is potentially sensitive, so this API and similar ones are secured behind an API Key. This is a UUID that must be provided with the request, or else the status module will return a <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401>401</a>.</p><p>The key(s) must be provided in one of the config files, e.g.</p><pre><code>&quot;status&quot;:
{
	&quot;port&quot;: 8011,
	&quot;cert&quot;: &quot;./cert.pem&quot;,
	&quot;key&quot;: &quot;./key.pem&quot;,
	&quot;apikeys&quot;: [&quot;40b14fa9-230d-43a6-b5f4-0b6c6cca5fd2&quot;]
},
</code></pre><p>After which the key must be be provided in a cookie, or via a query parameter, e.g.</p><p><code>https://localhost:8011/rooms?apikey=40b14fa9-230d-43a6-b5f4-0b6c6cca5fd2</code></p><p>Nexus has been given an API key accessible only to the Ubiq team members.</p><p><strong>If no API key is set, then all APIs default to public, not private, so be sure to configure this if your server can be accessed externally.</strong></p><p>The status module is now the supported way to capture server parameters for experiments, and the status streams have been removed in this update.</p><h3 id=notes-on-security>Notes on security</h3><p>As we always say when introducing Ubiq, Ubiq is designed to operate in a high-trust environment. The API keys are in place not to protect the server from malicious actors, but to make it harder for users sharing a resource (i.e. the server), to <em>accidentally</em> interfere with each other.</p><p>Without the ability to get a list of rooms programmatically, users can&rsquo;t write code that, for example, enumerates and joins said rooms.</p><p>Writing secure code is hard, and beyond the scope of our team. For building a truly secure public facing app, we recommend opening a <a href=https://github.com/UCL-VR/ubiq/discussions>discussion on GitHub</a>.</p><h3 id=webrtc>WebRTC</h3><p>The rtcpeerconnection sample has been removed. This sample used <a href=https://www.npmjs.com/package/wrtc>wrtc</a> to establish a PeerConnection with Node.</p><p>This has been removed partly because wrtc looks like it is out of development. Additionally, for WebRTC & JavaScript, the Browser samples now serve as working examples.</p><p>Finally, the WebRTC API is very difficult for non-experts to work with. Our recommended way for users to send audio and video for server-side processing, is to serialise and transmit it themselves. This is the approach used by our own projects.</p><h2 id=future-work>Future Work</h2><p>This is the first of two large server projects.</p><p>In our next project, we aim to enhance the extensibility of the server. This has two main aims:</p><ol><li>To make it possible to add &lsquo;server-level&rsquo; NetworkComponents, that exist just above a Room. This will allow users to create server features without altering upstream code. It will also allow us to split off certain services such as the Blob API and Discovery APIs into their own modules.</li><li>To make it easier to subclass the Room and RoomPeer types to add abilities that are not encompassed by (1). This came out of our <a href=https://doi.org/10.1109/DS-RT58998.2023.00016>scalability project</a>, which needed to change the behaviour of how messages were routed between rooms. We would like to be able to support projects like this without needing any upstream changes.</li></ol><h2 id=conclusion>Conclusion</h2><p>The TypeScript upgrade has improved the quality of the code and revealed a number of minor issues that have been resolved, while the other changes lay a foundation for more efficient server feature development in the future.</p><p>We hope despite how invasive these changes are, there will be little to no change of the vast majority of projects, including those that already work with the server.</p><p>In future posts we will go into more detail about the Status Module, and our new proposed features.</p><p>As always, please reach out on Discord, GitHub or via E-mail with suggestions and comments!</p></article></div></div></div></div><section class="section section-sm mt-n5 mb-3"><div class=container><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"></div></div></div></section><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline><li class=list-inline-item><a href=/privacy-policy/>Privacy</a></li></ul></div></div></div></footer><script data-goatcounter=https://ubiq.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<script src=/js/bootstrap.min.fdbe9b9ba88a036135318f3c721784d684ac9e3280fe282cc80d7d49f7f9c82780cd54228c1608685a230c09984300d7946fc471734d566fcebc148b65bd16db.js integrity="sha512-/b6bm6iKA2E1MY88cheE1oSsnjKA/igsyA19Sff5yCeAzVQijBYIaFojDAmYQwDXlG/EcXNNVm/OvBSLZb0W2w==" crossorigin=anonymous defer></script>
<script src=/js/highlight.min.2a3ca603c4e5468838fb437bc036b9ddc036b6668b5dd45804f048229ea684f98f5928dd485b41db90e55aaa28b36600341f082d2726650a0a394250b6bf3ac1.js integrity="sha512-KjymA8TlRog4+0N7wDa53cA2tmaLXdRYBPBIIp6mhPmPWSjdSFtB25DlWqoos2YANB8ILScmZQoKOUJQtr86wQ==" crossorigin=anonymous defer></script>
<script src=/main.min.7692813ef22de5d343339990192d5774c0742a9334f8f57bb78245f5ab0e02861e3e47e7308e649ca0173ef9e307477de2769299fdb90a9e4a5e327df94553b7.js integrity="sha512-dpKBPvIt5dNDM5mQGS1XdMB0KpM0+PV7t4JF9asOAoYePkfnMI5knKAXPvnjB0d94naSmf25Cp5KXjJ9+UVTtw==" crossorigin=anonymous defer></script></body></html>